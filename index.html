<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="/manifest.json">
    <title>Casa do Mar</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.24/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary-color: #004080;
            --secondary-color: #64B5F6;
            --light-color: #E3F2FD;
            --dark-color: #0D47A1;
            --success-color: #4CAF50;
            --error-color: #F44336;
            --text-color: #333;
            --light-text: #fff;
            --gray-text: #666;
            --background: #f5f5f5;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: var(--background);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
            width: 100%;
            padding-bottom: 80px;
        }
        header {
            background-color: var(--primary-color);
            color: var(--light-text);
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.2rem;
            font-weight: bold;
        }
        #logout-button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            margin-bottom: 15px;
            overflow: hidden;
        }
        .card-header {
            border-bottom: 3px solid #F5F5F5;
            color: #004080;
            padding: 10px;
            font-weight: bold;
            align-items: center;
            display: flex;
            justify-content: center;
            gap: 5px;
        }
        .card-body {
            padding: 20px;
        }

        /* --- ESTILOS DE COMPONENTES ADICIONAIS --- */

        /* Auth Container */
        #auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.3s;
        }
        #login-card {
            width: 90%;
            max-width: 400px;
            padding: 30px;
        }
        .hidden {
            display: none !important;
        }

        /* Loader */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal Genérico (para Alertas e Confirmações) */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }
        .modal.visible {
            display: flex;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .modal-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        .close-modal {
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--gray-text);
        }
        .modal-body {
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--gray-text);
        }
        .form-group input,.form-group textarea,.form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .form-group textarea {
            min-height: 80px;
        }
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: #ddd; color: var(--text-color); }
        .btn-danger { background-color: var(--error-color); color: white; }

        /* --- ESTILOS DAS ABAS --- */

        /* CALENDÁRIO */
        .calendar-container { width: 100%; max-width: 100%; margin: 0 auto; }
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 10px; }
        .calendar-header { font-weight: bold; text-align: center; padding: 8px 2px; background-color: var(--background); font-size: 0.85rem; color: var(--primary-color); }
        .calendar-day { padding: 6px 2px; text-align: center; border-radius: 3px; cursor: pointer; border: 1px solid #D5D5D5; font-size: 0.85rem; aspect-ratio: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: transform 0.2s; }
        .calendar-day:hover { transform: scale(1.05); }
        .calendar-day.today { border: 2px solid var(--primary-color); position: relative; font-weight: bold; }
        .calendar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; color: var(--primary-color); border: 2px solid var(--primary-color); padding: 5px 8px; border-radius: 4px; }
        .calendar-controls button { background: var(--primary-color); color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; }
        .calendar-controls h3 { margin: 0; font-size: 1rem; text-align: center; flex-grow: 1; }
        .reserva-airbnb { background-color: #FFC0CB; }
        .reserva-particular { background-color: #C4E1FF; }
        .reserva-limpeza { background-color: #FFA07A; }
        .reserva-servico { background-color: #FFFF99; }
        .legenda-container { display: flex; justify-content: space-evenly; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
        .legenda-item { display: flex; font-size: 10px; text-align: center; align-items: center; cursor: pointer; padding: 5px; border-radius: 4px; border: 1px solid transparent; transition: all 0.2s; }
        .legenda-item.selecionada { border-color: var(--primary-color); background-color: var(--light-color); }
        .legenda-cor { width: 18px; height: 18px; border-radius: 50%; margin-right: 5px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); }

        /* Próximo Evento */
        .next-event-card { margin-top: 20px; }
        .next-event-content .row { display: flex; justify-content: space-between; align-items: center; }
        .sem-eventos { display: flex; justify-content: center; align-items: center; color: var(--primary-color); padding: 10px; }
        .next-event-content .evento-tipo { padding: 2px 8px; border-radius: 4px; color: var(--primary-color); margin-right: 10px; }
        .next-event-content .evento-data { display: flex; align-items: center; color: var(--primary-color); }
        .next-event-content .evento-data i.material-icons { margin-right: 5px; }
        .reserva-detalhe { display: flex; align-items: center; gap: 8px; color: var(--primary-color); margin-top: 10px; }

        /* RESERVAS */
        .reserva-tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid #ddd; }
        .reserva-tab { padding: 10px 15px; cursor: pointer; border-bottom: 2px solid transparent; }
        .reserva-tab.active { border-bottom: 2px solid var(--primary-color); color: var(--primary-color); font-weight: bold; }
        .reserva-status { display: inline-block; padding: 3px 8px; background-color: #c4e1ff; border-radius: 4px; font-size: 0.6rem; font-weight: bold; color: #004080; margin-bottom: 5px; }
        .reserva-status.ativo { background-color: #C8E6C9; color: #2E7D32; }
        .reserva-detail { display: flex; align-items: center; gap: 0.5rem; padding: 5px; }
        .reserva-detail i { font-size: 20px; margin-right: 5px; vertical-align: middle; color: var(--primary-color); }
        .reserva-row { display: flex; justify-content: space-between; gap: 1rem; }
        .payment-icon { cursor: pointer; margin-left: 5px; color: #bdbdbd; vertical-align: middle; font-size: 24px; border-radius: 20px; border: 2px solid var(--primary-color); }
        .payment-icon.pago { color: var(--success-color); border-color: var(--success-color); }
        .reserva-notas { margin-top: 10px; padding: 10px; background-color: #f9f9f9; border-radius: 5px; font-style: italic; white-space: pre-wrap; word-wrap: break-word; }
        .date-input-group { display: flex; gap: 10px; }
        .date-input-group .form-group { flex: 1; }

        /* Botão Adicionar Flutuante */
        .add-button { position: fixed; bottom: 80px; right: 30px; width: 45px; height: 45px; border-radius: 50%; background-color: var(--primary-color); color: white; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); cursor: pointer; transition: all 0.3s; z-index: 100; }
        .add-button:hover { background-color: var(--dark-color); transform: scale(1.1); }

        /* FINANCEIRO */
        .finance-content { display: none; }
        .finance-content.active { display: block; }
        .periodo-container { padding: 10px 15px; }
        .btn-icon-relatorio { font-size: 1.5em; color: var(--primary-color); cursor: pointer; margin-left: auto; padding: 8px; border-radius: 5px; }
        .periodo-navegacao { display: flex; align-items: center; justify-content: center; gap: 40px; }
        .periodo-botao { background-color: var(--primary-color); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; }
        .periodo-exibicao { font-size: 1rem; font-weight: bold; color: var(--primary-color); min-width: 160px; text-align: center; }
        .finance-tabs { display: flex; margin-bottom: 20px; }
        .finance-tab { flex: 1; text-align: center; padding: 8px; cursor: pointer; border-bottom: 2px solid #F2F2F2; }
        .finance-tab.active { color: #004080; border-bottom: 2.5px solid #004080; font-weight: bold; }
        .tipo-lancamento { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-tipo { flex: 1; padding: 10px; background: #f5f5f5; border-radius: 4px; cursor: pointer; font-weight: bold; color: #FFFFFF; border: 1px solid #fff; }
        .btn-tipo.active { border-color: var(--primary-color); background-color: var(--light-color); }
        #botao-receita { background: #4CAF50; }
        #botao-despesa { background: #F44336; }
        .lancamento-item { display: flex; flex-direction: column; border-radius: 5px; padding: 10px; background-color: #FFFFFF; }
        .lancamento-linha-superior, .lancamento-linha-inferior { display: flex; justify-content: space-between; }
        .lancamento-linha-superior { margin-bottom: 5px; }
        .lancamento-data, .lancamento-descricao, .lancamento-valor { font-size: 14px; color: #333; }
        .lancamento-categoria { font-size: 14px; color: var(--primary-color); }
        .lancamento-valor { font-weight: bold; text-align: right; }
        .lancamento-item.receita .lancamento-valor { color: #4CAF50; }
        .lancamento-item.despesa .lancamento-valor { color: #f44336; }
        .lancamento-item.receita { border-left: 4px solid var(--success-color); }
        .lancamento-item.despesa { border-left: 4px solid var(--error-color); }

        /* Swipe Actions */
        .swipe-container { position: relative; overflow: hidden; border-radius: 5px; margin-bottom: 10px; }
        .swipe-content { position: relative; background-color: white; transition: transform 0.3s ease; z-index: 1; }
        .swipe-actions { position: absolute; top: 0; right: 0; height: 100%; display: flex; align-items: center; z-index: 0; transform: translateX(100%); }
        .swipe-container.swiped .swipe-content { transform: translateX(-120px); }
        .swipe-container.swiped .swipe-actions { transform: translateX(0); }
        .swipe-action-btn { width: 50px; height: 50px; margin: 0 5px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; border: none; }
        .swipe-action-btn.edit { background-color: var(--secondary-color); }
        .swipe-action-btn.delete { background-color: var(--error-color); }

        /* Resumo Mensal */
        .resumo-item { padding: 10px; display: flex; justify-content: space-between; border-bottom: 1px solid #eee; }
        .resumo-item.receita { background-color: rgba(76, 175, 80, 0.1); }
        .resumo-item.despesa { background-color: rgba(244, 67, 54, 0.1); }
        .resumo-item.saldo { font-weight: bold; background-color: #E3F2FD; }

        /* ORÇAMENTO */
        .slider-container { margin-bottom: 10px; }
        .slider-label { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        input[type="range"] { width: 100%; -webkit-appearance: none; background: #ddd; border-radius: 5px; outline: none; height: 5px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--primary-color); border-radius: 50%; cursor: pointer; }
        .summary-total { font-weight: bold; font-size: 1.2rem; color: var(--primary-color); border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; }
        .lock-icon { cursor: pointer; }
        input[type="range"]:disabled { opacity: 0.7; }
        .airbnb-calculation { display: flex; justify-content: space-between; align-items: center; padding: 10px; font-size: 1rem; border-bottom: 1px solid #eee; }
        .fee-detail { font-size: 0.9rem; color: #4CAF50; }

        /* NAVEGAÇÃO INFERIOR */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: white; box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-around; padding: 10px 0; z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--gray-text); text-decoration: none; font-size: 0.8rem; flex: 1; cursor: pointer; }
        .nav-item.active { color: var(--primary-color); }
        .nav-icon { font-size: 24px; margin-bottom: 4px; }
        @media (max-width: 768px) { .app-container { padding: 10px; } }
    </style>
</head>
<body>
    <!-- Elementos Globais -->
    <div id="loader" class="loader-overlay hidden">
        <div class="loader"></div>
    </div>
    
    <div id="auth-container">
        <div id="login-card" class="card">
            <h3 class="card-header">Login - Casa do Mar</h3>
            <div class="card-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" required autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label for="password">Senha</label>
                        <input type="password" id="password" required autocomplete="current-password">
                    </div>
                    <div class="form-actions" style="justify-content: center;">
                        <button type="submit" class="btn btn-primary">Entrar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="alertModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="alertTitle" class="modal-title">Aviso</h5>
                <span class="close-modal material-icons" data-close-modal="alertModal">close</span>
            </div>
            <div id="alertBody" class="modal-body"></div>
            <div class="form-actions">
                <button type="button" class="btn btn-primary" data-close-modal="alertModal">OK</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="confirmTitle" class="modal-title">Confirmar</h5>
                 <span class="close-modal material-icons" data-close-modal="confirmModal">close</span>
            </div>
            <div id="confirmBody" class="modal-body"></div>
            <div class="form-actions">
                <button type="button" id="confirmCancelBtn" class="btn btn-secondary">Cancelar</button>
                <button type="button" id="confirmOkBtn" class="btn btn-danger">Confirmar</button>
            </div>
        </div>
    </div>

    <header class="hidden">
        <div class="logo">Casa do Mar</div>
        <button id="logout-button" title="Sair">
            <i class="material-icons">logout</i>
        </button>
    </header>

    <main class="app-container hidden">
        <!-- Calendário Tab -->
        <div id="calendario" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <i class="material-icons">calendar_today</i>
                    <span>CALENDÁRIO DE RESERVAS</span>
                </div>
                <div class="card-body" style="overflow-x: auto;">
                    <div class="calendar-container">
                        <div class="calendar-controls">
                            <button id="btn-mes-anterior" aria-label="Mês anterior">❮</button>
                            <h3 id="mesAtual">Dezembro 2023</h3>
                            <button id="btn-mes-seguinte" aria-label="Mês seguinte">❯</button>
                        </div>
                    </div>
                    <div class="calendar" id="calendar-grid"></div>
                    <div id="legenda-container" class="legenda-container">
                        <div class="legenda-item selecionada" data-tipo-reserva="particular">
                            <div class="legenda-cor" style="background-color: #C4E1FF;"></div>
                            <span>Casa do Mar</span>
                        </div>
                        <div class="legenda-item" data-tipo-reserva="airbnb">
                            <div class="legenda-cor" style="background-color: #FFC0CB;"></div>
                            <span>Airbnb</span>
                        </div>
                        <div class="legenda-item" data-tipo-reserva="limpeza">
                            <div class="legenda-cor" style="background-color: #FFA07A;"></div>
                            <span>Limpeza</span>
                        </div>
                        <div class="legenda-item" data-tipo-reserva="servico">
                            <div class="legenda-cor" style="background-color: #FFFF99;"></div>
                            <span>Serviço</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card next-event-card">
                <div id="next-event-header" class="card-header">Próximo Evento</div>
                <div class="card-body" id="next-event-container"></div>
            </div>
        </div>

        <!-- Reservas Tab -->
        <div id="reservas" class="tab-content">
            <div class="card">
                <div class="card-header"><i class="material-icons">book</i><span>PAINEL DE RESERVAS</span></div>
                <div class="card-body">
                    <div class="reserva-tabs">
                        <div class="reserva-tab active" data-filtro="ativas">Reservas Ativas</div>
                        <div class="reserva-tab" data-filtro="historico">Histórico de Reservas</div>
                    </div>
                    <div id="reservas-container"></div>
                </div>
            </div>
        </div>

        <!-- Financeiro Tab -->
        <div id="financeiro" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <i class="material-icons">attach_money</i>
                    <span>EXTRATO FINANCEIRO</span>
                    <i id="btn-gerar-relatorio" class="material-icons btn-icon-relatorio" title="Gerar Relatório PDF" aria-label="Gerar Relatório PDF">description</i>
                </div>
                <div class="card-body periodo-container">
                    <div class="periodo-navegacao">
                        <button class="periodo-botao" id="btn-mes-anterior-financeiro" aria-label="Mês anterior">
                            <i class="material-icons">chevron_left</i>
                        </button>
                        <div class="periodo-exibicao">
                            <span id="mesAtualFinanceiro"></span>
                        </div>
                        <button class="periodo-botao" id="btn-mes-seguinte-financeiro" aria-label="Mês seguinte">
                            <i class="material-icons">chevron_right</i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="finance-tabs">
                        <div class="finance-tab active" data-aba="geral">Geral</div>
                        <div class="finance-tab" data-aba="receitas">Receitas</div>
                        <div class="finance-tab" data-aba="despesas">Despesas</div>
                    </div>
                    <div id="geral" class="finance-content active">
                        <div id="extrato-geral-container"></div>
                    </div>
                    <div id="receitas" class="finance-content">
                        <div id="extrato-receitas-container"></div>
                    </div>
                    <div id="despesas" class="finance-content">
                        <div id="extrato-despesas-container"></div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Resumo Mensal</div>
                <div class="card-body">
                    <div class="resumo-item receita">
                        <span>Total Receitas:</span>
                        <span id="total-receitas">R$ 0,00</span>
                    </div>
                    <div class="resumo-item despesa">
                        <span>Total Despesas:</span>
                        <span id="total-despesas">R$ 0,00</span>
                    </div>
                    <div class="resumo-item saldo">
                        <span>Saldo do Mês:</span>
                        <span id="saldo-mensal">R$ 0,00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orçamento Tab -->
        <div id="orcamento" class="tab-content">
             <!-- O conteúdo do orçamento pode ser adicionado aqui depois -->
        </div>

        <!-- Botão Adicionar -->
        <div id="add-button" class="add-button" style="display: none;">
            <i class="material-icons">add</i>
        </div>
    </main>

    <!-- Modais -->
    <div id="reservaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalReservaTitle">Nova Reserva</div>
                <span class="close-modal material-icons" data-close-modal="reservaModal">close</span>
            </div>
            <form id="reservaForm">
                <input type="hidden" id="reservaId">
                <div class="form-group">
                    <label for="nomeHospede">Nome do Hóspede</label>
                    <input type="text" id="nomeHospede" required>
                </div>
                <div class="form-group">
                    <label for="telefoneHospede">Telefone</label>
                    <input type="tel" id="telefoneHospede" required>
                </div>
                <div class="date-input-group">
                    <div class="form-group">
                        <label for="dataEntrada">Data de Entrada</label>
                        <input type="date" id="dataEntrada" required>
                    </div>
                    <div class="form-group">
                        <label for="dataSaida">Data de Saída</label>
                        <input type="date" id="dataSaida" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="quantidadeHospedes">Quantidade de Hóspedes</label>
                    <input type="number" id="quantidadeHospedes" min="1" required>
                </div>
                <div class="form-group">
                    <label for="valorReserva">Valor da Reserva (R$)</label>
                    <input type="number" id="valorReserva" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="notasReserva">Notas</label>
                    <textarea id="notasReserva"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" data-close-modal="reservaModal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="lancamentoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalLancamentoTitle">Novo Lançamento</div>
                <span class="close-modal material-icons" data-close-modal="lancamentoModal">close</span>
            </div>
            <form id="lancamentoForm">
                 <input type="hidden" id="lancamentoId">
                <div class="form-group">
                    <label>Tipo de Lançamento</label>
                    <div class="tipo-lancamento">
                        <button type="button" class="btn-tipo active" data-tipo="receita" id="botao-receita">Receita</button>
                        <button type="button" class="btn-tipo" data-tipo="despesa" id="botao-despesa">Despesa</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="dataLancamento">Data</label>
                    <input type="date" id="dataLancamento" required>
                </div>
                <div class="form-group">
                    <label for="categoriaLancamento">Categoria</label>
                    <select id="categoriaLancamento" required></select>
                </div>
                <div class="form-group">
                    <label for="descricaoLancamento">Descrição</label>
                    <input type="text" id="descricaoLancamento" required>
                </div>
                <div class="form-group">
                    <label for="valorLancamento">Valor (R$)</label>
                    <input type="number" step="0.01" min="0" id="valorLancamento" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" data-close-modal="lancamentoModal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Navegação Inferior -->
    <nav class="bottom-nav hidden">
        <div class="nav-item active" data-tab="calendario">
            <i class="material-icons nav-icon">calendar_today</i>
            <span>Calendário</span>
        </div>
        <div class="nav-item" data-tab="reservas">
            <i class="material-icons nav-icon">book</i>
            <span>Reservas</span>
        </div>
        <div class="nav-item" data-tab="financeiro">
            <i class="material-icons nav-icon">attach_money</i>
            <span>Financeiro</span>
        </div>
        <div class="nav-item" data-tab="orcamento">
            <i class="material-icons nav-icon">calculate</i>
            <span>Orçamento</span>
        </div>
    </nav>

<script type="module">
    // --------------------------------------------------------------------
    // IMPORTAÇÕES E CONFIGURAÇÃO DO FIREBASE
    // --------------------------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, doc, collection, setDoc, deleteDoc, onSnapshot, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDax5mqsMnkh90HXSSzalJEbA_tVBUh3lA",
        authDomain: "casadomar.firebaseapp.com",
        projectId: "casadomar",
        storageBucket: "casadomar.appspot.com",
        messagingSenderId: "333707948180",
        appId: "1:333707948180:web:53cfed12808bb11fb20481",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --------------------------------------------------------------------
    // ESTADO DA APLICAÇÃO
    // --------------------------------------------------------------------
    const AppState = {
        reservas: [],
        lancamentos: [],
        calendarioManual: {},
        calendario: {
            mes: new Date().getMonth(),
            ano: new Date().getFullYear(),
            tipoReservaSelecionado: 'particular',
        },
        financeiro: {
            mes: new Date().getMonth(),
            ano: new Date().getFullYear(),
        },
        ui: {
            abaAtivaReservas: 'ativas',
            abaAtivaFinanceiro: 'geral',
            activeTab: 'calendario',
        },
        confirmCallback: null,
        listeners: { // Para cancelar os listeners ao fazer logout
            reservas: null,
            lancamentos: null,
            calendario: null,
        },
    };

    const MESES = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
    const CATEGORIAS = {
        receita: ['Airbnb', 'Casa do Mar', 'Aporte'],
        despesa: ['Água (Caern)', 'Água Mineral', 'Combustível', 'DAS/MEI', 'Energia (Cosern)', 'Energia Solar (BNB)', 'Faxina', 'Cartão Crédito', 'Internet', 'Lavanderia', 'Material Construção', 'Material Limpeza/Higiene', 'Piscineiro (Honey)', 'Remuneração', 'Retirada', 'Serviço/Reparo/Manutenção', 'Serviços Gerais (Sr. Hailton)', 'Taxas/Impostos', 'Vigilância', 'Compras Diversas']
    };

    // --------------------------------------------------------------------
    // FUNÇÕES DE UTILIDADE
    // --------------------------------------------------------------------
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    const formatarMoeda = (valor) => `R$ ${parseFloat(valor || 0).toFixed(2).replace('.', ',')}`;
    const formatarData = (dataStr) => { // YYYY-MM-DD -> DD/MM/YYYY
        if (!dataStr) return '';
        const [ano, mes, dia] = dataStr.split('-');
        return `${dia}/${mes}/${ano}`;
    };
    const showLoader = (show) => { $('#loader').classList.toggle('hidden', !show); };

    const showAlert = (message, title = 'Aviso') => {
        $('#alertTitle').textContent = title;
        $('#alertBody').textContent = message;
        $('#alertModal').classList.add('visible');
    };

    const showConfirm = (message, title = 'Confirmar') => {
        return new Promise((resolve) => {
            $('#confirmTitle').textContent = title;
            $('#confirmBody').textContent = message;
            $('#confirmModal').classList.add('visible');
            
            AppState.confirmCallback = (result) => {
                $('#confirmModal').classList.remove('visible');
                AppState.confirmCallback = null; // Limpa o callback
                resolve(result);
            };
        });
    };
    
    // --------------------------------------------------------------------
    // LÓGICA DE AUTENTICAÇÃO
    // --------------------------------------------------------------------
    
    onAuthStateChanged(auth, (user) => {
        const authContainer = $('#auth-container');
        const mainContent = $('main');
        const header = $('header');
        const bottomNav = $('.bottom-nav');

        if (user) {
            // Usuário logado
            authContainer.classList.add('hidden');
            mainContent.classList.remove('hidden');
            header.classList.remove('hidden');
            bottomNav.classList.remove('hidden');
            iniciarListenersFirebase();
        } else {
            // Usuário deslogado
            authContainer.classList.remove('hidden');
            mainContent.classList.add('hidden');
            header.classList.add('hidden');
            bottomNav.classList.add('hidden');
            pararListenersFirebase();
            showLoader(false);
        }
    });

    async function handleLogin(event) {
        event.preventDefault();
        const email = $('#email').value;
        const password = $('#password').value;
        showLoader(true);
        try {
            await signInWithEmailAndPassword(auth, email, password);
            // onAuthStateChanged irá cuidar de esconder o loader e mostrar o app
        } catch (error) {
            let friendlyMessage = "Ocorreu um erro ao tentar fazer login.";
            if (['auth/wrong-password', 'auth/user-not-found', 'auth/invalid-credential'].includes(error.code)) {
                friendlyMessage = "Email ou senha inválidos. Por favor, tente novamente.";
            }
            showAlert(friendlyMessage, "Falha no Login");
            showLoader(false);
        }
    }

    async function handleLogout() {
        if(await showConfirm("Tem certeza que deseja sair?", "Sair")) {
            try {
                await signOut(auth);
            } catch (error) {
                showAlert("Ocorreu um erro ao tentar sair.", "Erro");
            }
        }
    }

    // --------------------------------------------------------------------
    // LÓGICA DO FIREBASE (BANCO DE DADOS)
    // --------------------------------------------------------------------

    function iniciarListenersFirebase() {
        if (AppState.listeners.reservas) return; // Já estão ativos

        showLoader(true);
        const cargasIniciais = {reservas: false, lancamentos: false, calendario: false};
        
        const verificarCargaCompleta = () => {
            if (Object.values(cargasIniciais).every(Boolean)) {
                 showLoader(false);
                 renderizarTudo();
                 // verificarReservasVencidas(); // Adicionar lógica depois
            }
        };

        const reservasRef = collection(db, "reservas");
        AppState.listeners.reservas = onSnapshot(reservasRef, (snapshot) => {
            AppState.reservas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            cargasIniciais.reservas = true;
            verificarCargaCompleta();
        }, (error) => console.error("Erro ao carregar reservas:", error));

        const lancamentosRef = collection(db, "lancamentos");
        AppState.listeners.lancamentos = onSnapshot(lancamentosRef, (snapshot) => {
            AppState.lancamentos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            cargasIniciais.lancamentos = true;
            verificarCargaCompleta();
        }, (error) => console.error("Erro ao carregar lançamentos:", error));

        const calendarioRef = doc(db, "calendario", "manual");
        AppState.listeners.calendario = onSnapshot(calendarioRef, (docSnap) => {
            AppState.calendarioManual = docSnap.exists() ? docSnap.data() : {};
            cargasIniciais.calendario = true;
            verificarCargaCompleta();
        }, (error) => console.error("Erro ao carregar calendário manual:", error));
    }
    
    function pararListenersFirebase() {
        if (AppState.listeners.reservas) AppState.listeners.reservas();
        if (AppState.listeners.lancamentos) AppState.listeners.lancamentos();
        if (AppState.listeners.calendario) AppState.listeners.calendario();
        AppState.listeners = {reservas: null, lancamentos: null, calendario: null};
    }

    // --------------------------------------------------------------------
    // FUNÇÕES PRINCIPAIS DE RENDERIZAÇÃO
    // --------------------------------------------------------------------

    function renderizarTudo() {
        renderizarCalendario();
        renderizarReservas();
        renderizarFinanceiro();
        // Adicionar renderizarOrcamento() se necessário
    }
    
    // ... Aqui entram todas as funções de renderização e lógica do app ...
    // ... (Vou adicionar a lógica refatorada abaixo) ...
    

    // --------------------------------------------------------------------
    // INICIALIZAÇÃO E EVENT LISTENERS GLOBAIS
    // --------------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', () => {
        // Listeners de Autenticação
        $('#loginForm').addEventListener('submit', handleLogin);
        $('#logout-button').addEventListener('click', handleLogout);

        // Listeners para fechar modais
        $$('[data-close-modal]').forEach(el => {
            el.addEventListener('click', () => {
                const modalId = el.getAttribute('data-close-modal');
                $(`#${modalId}`).classList.remove('visible');
            });
        });

        $('#confirmCancelBtn').addEventListener('click', () => {
            if (AppState.confirmCallback) AppState.confirmCallback(false);
        });
        $('#confirmOkBtn').addEventListener('click', () => {
            if (AppState.confirmCallback) AppState.confirmCallback(true);
        });

        // Listeners da UI principal (adicionados aqui para garantir que o DOM existe)
        $('.bottom-nav').addEventListener('click', (e) => {
            const navItem = e.target.closest('.nav-item');
            if(navItem) {
                const tabName = navItem.dataset.tab;
                openTab(tabName);
            }
        });

        // Adicionar outros listeners principais aqui
        $('#btn-mes-anterior').addEventListener('click', () => mudarMes(-1));
        $('#btn-mes-seguinte').addEventListener('click', () => mudarMes(1));

        $('#legenda-container').addEventListener('click', (e) => {
            const legendaItem = e.target.closest('.legenda-item');
            if (legendaItem) {
                selecionarTipoReserva(legendaItem.dataset.tipoReserva);
            }
        });
        
         $('#reservaForm').addEventListener('submit', handleSalvarReserva);
    });

    // --------------------------------------------------------------------
    // LÓGICA DO CALENDÁRIO
    // --------------------------------------------------------------------

    function renderizarCalendario() {
        const { mes, ano } = AppState.calendario;
        const calendarGrid = $('#calendar-grid');
        const mesAtualElement = $('#mesAtual');
        
        mesAtualElement.textContent = `${MESES[mes]} ${ano}`;
        calendarGrid.innerHTML = '';

        const diasSemana = ["Seg", "Ter", "Qua", "Qui", "Sex", "Sáb", "Dom"];
        diasSemana.forEach(dia => {
            const header = document.createElement('div');
            header.className = 'calendar-header';
            header.textContent = dia;
            calendarGrid.appendChild(header);
        });

        const primeiroDia = new Date(ano, mes, 1);
        const ultimoDia = new Date(ano, mes + 1, 0);
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);

        let diaSemanaInicio = primeiroDia.getDay();
        diaSemanaInicio = diaSemanaInicio === 0 ? 6 : diaSemanaInicio - 1;

        for (let i = 0; i < diaSemanaInicio; i++) {
            calendarGrid.appendChild(document.createElement('div'));
        }

        const datasReservadas = {};
        AppState.reservas.forEach(reserva => {
            let dataCorrente = new Date(reserva.dataEntrada + 'T00:00:00');
            const dataFim = new Date(reserva.dataSaida + 'T00:00:00');
            while (dataCorrente <= dataFim) {
                const dataKey = dataCorrente.toISOString().split('T')[0];
                datasReservadas[dataKey] = { tipo: 'particular', protegido: true, reserva: reserva };
                dataCorrente.setDate(dataCorrente.getDate() + 1);
            }
        });
        
        const calendarioConsolidado = {...AppState.calendarioManual, ...datasReservadas};

        for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
            const diaElement = document.createElement('div');
            const dataAtual = new Date(ano, mes, dia);
            const dataKey = dataAtual.toISOString().split('T')[0];

            diaElement.className = 'calendar-day';
            diaElement.textContent = dia;
            diaElement.dataset.date = dataKey;

            if (dataAtual.getTime() === hoje.getTime()) {
                diaElement.classList.add('today');
            }

            if (calendarioConsolidado[dataKey]) {
                const info = calendarioConsolidado[dataKey];
                diaElement.classList.add(`reserva-${info.tipo}`);
                if (info.reserva) {
                     diaElement.title = `Reserva: ${info.reserva.nome}\n${formatarData(info.reserva.dataEntrada)} - ${formatarData(info.reserva.dataSaida)}`;
                }
            }

            calendarGrid.appendChild(diaElement);
        }
        
        // Adicionar listener de clique para a grade do calendário
        calendarGrid.addEventListener('click', handleCliqueDiaCalendario);
    }
    
    async function handleCliqueDiaCalendario(e) {
        if (!e.target.classList.contains('calendar-day') || !e.target.dataset.date) return;
        
        const dataKey = e.target.dataset.date;
        const calendarioConsolidado = { ...AppState.calendarioManual, ...obterDatasReservadas() };
        
        if (calendarioConsolidado[dataKey] && calendarioConsolidado[dataKey].protegido) {
            showAlert('Esta data está bloqueada por uma reserva existente.');
            return;
        }

        const novoCalendarioManual = { ...AppState.calendarioManual };
        if (novoCalendarioManual[dataKey]) {
            delete novoCalendarioManual[dataKey];
        } else {
            novoCalendarioManual[dataKey] = { tipo: AppState.calendario.tipoReservaSelecionado };
        }
        
        try {
            await setDoc(doc(db, "calendario", "manual"), novoCalendarioManual);
            // O listener onSnapshot irá chamar a re-renderização automaticamente.
        } catch(error) {
            console.error("Erro ao salvar marcação manual:", error);
            showAlert("Não foi possível salvar a alteração no calendário.");
        }
    }
    
    function obterDatasReservadas() {
        const datas = {};
        AppState.reservas.forEach(reserva => {
            let dataCorrente = new Date(reserva.dataEntrada + 'T00:00:00');
            const dataFim = new Date(reserva.dataSaida + 'T00:00:00');
            while (dataCorrente <= dataFim) {
                const dataKey = dataCorrente.toISOString().split('T')[0];
                datas[dataKey] = { tipo: 'particular', protegido: true, reserva: reserva };
                dataCorrente.setDate(dataCorrente.getDate() + 1);
            }
        });
        return datas;
    }

    function mudarMes(delta) {
        AppState.calendario.mes += delta;
        if (AppState.calendario.mes > 11) {
            AppState.calendario.mes = 0;
            AppState.calendario.ano++;
        } else if (AppState.calendario.mes < 0) {
            AppState.calendario.mes = 11;
            AppState.calendario.ano--;
        }
        renderizarCalendario();
    }

    function selecionarTipoReserva(tipo) {
        AppState.calendario.tipoReservaSelecionado = tipo;
        $$('.legenda-item').forEach(item => {
            item.classList.toggle('selecionada', item.dataset.tipoReserva === tipo);
        });
    }


    // --------------------------------------------------------------------
    // LÓGICA DE RESERVAS
    // --------------------------------------------------------------------
    function renderizarReservas() {
        const container = $('#reservas-container');
        container.innerHTML = '';
        
        const hoje = new Date();
        hoje.setHours(0,0,0,0);
        
        const filtro = AppState.ui.abaAtivaReservas;
        
        const reservasFiltradas = AppState.reservas.filter(reserva => {
            const fim = new Date(reserva.dataSaida + 'T00:00:00');
            return filtro === 'ativas' ? fim >= hoje : fim < hoje;
        });

        // Ordenação
        reservasFiltradas.sort((a,b) => {
            const dataA = new Date(a.dataEntrada);
            const dataB = new Date(b.dataEntrada);
            return filtro === 'ativas' ? dataA - dataB : dataB - dataA;
        });
        
        if(reservasFiltradas.length === 0) {
            container.innerHTML = `<p style="padding: 20px; text-align: center;">Nenhuma reserva encontrada.</p>`;
            return;
        }

        reservasFiltradas.forEach(reserva => {
            const el = document.createElement('div');
            el.className = 'swipe-container';
            el.innerHTML = criarHTMLReserva(reserva);
            container.appendChild(el);
        });
    }

    function criarHTMLReserva(reserva) {
        const hoje = new Date();
        hoje.setHours(0,0,0,0);
        const inicio = new Date(reserva.dataEntrada + 'T00:00:00');
        const fim = new Date(reserva.dataSaida + 'T00:00:00');
        let status = '';

        if (AppState.ui.abaAtivaReservas === 'ativas') {
            if (hoje >= inicio && hoje <= fim) {
                status = '<div class="reserva-status ativo">EM ANDAMENTO</div>';
            } else if (hoje < inicio) {
                 // Lógica para "Próximo Evento" pode ser adicionada aqui se necessário
            }
        }
        
        // Sanitização simples para evitar XSS
        const nomeSeguro = escapeHTML(reserva.nome);
        const telefoneSeguro = escapeHTML(reserva.telefone);
        const hospedesSeguro = escapeHTML(reserva.hospedes);
        const notasSeguras = escapeHTML(reserva.notas);

        return `
            <div class="swipe-content">
                <div class="reserva-item">${status}</div>
                <div class="reserva-detail reserva-row">
                    <div class="reserva-info">
                        <i class="material-icons">calendar_today</i>
                        <span>${formatarData(reserva.dataEntrada)}</span>
                    </div>
                    <div class="reserva-info">
                        <i class="material-icons">calendar_today</i>
                        <span>${formatarData(reserva.dataSaida)}</span>
                    </div>
                </div>
                <div class="reserva-detail reserva-row">
                    <div class="reserva-info">
                        <i class="material-icons">person</i>
                        <span>${nomeSeguro}</span>
                    </div>
                    <div class="reserva-info">
                        <i class="material-icons">people</i>
                        <span>${hospedesSeguro} hóspedes</span>
                    </div>
                </div>
                <div class="reserva-detail reserva-row">
                    <div class="reserva-info">
                        <i class="material-icons">phone</i>
                        <a href="https://wa.me/55${telefoneSeguro.replace(/\D/g, '')}" target="_blank" style="color: inherit; text-decoration: none;">
                            ${telefoneSeguro}
                        </a>
                    </div>
                    <div class="reserva-info">
                        <i class="material-icons payment-icon ${reserva.pago ? 'pago' : ''}" data-action="toggle-pago" data-id="${reserva.id}">attach_money</i>
                        <span>${formatarMoeda(reserva.valor)}</span>
                    </div>
                </div>
                ${reserva.notas ? `<div class="reserva-notas">${notasSeguras}</div>` : ''}
            </div>
            <div class="swipe-actions">
                <button class="swipe-action-btn edit" data-action="editar-reserva" data-id="${reserva.id}"><i class="material-icons">edit</i></button>
                <button class="swipe-action-btn delete" data-action="excluir-reserva" data-id="${reserva.id}"><i class="material-icons">delete</i></button>
            </div>
        `;
    }

    function escapeHTML(str) {
        if (!str) return '';
        return str.toString()
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }
    
    async function handleSalvarReserva(event) {
        event.preventDefault();
        showLoader(true);

        const id = $('#reservaId').value;
        const dataEntrada = $('#dataEntrada').value;
        const dataSaida = $('#dataSaida').value;
        
        if (new Date(dataSaida) < new Date(dataEntrada)) {
            showAlert('A data de saída deve ser posterior à data de entrada!');
            showLoader(false);
            return;
        }

        // Lógica de verificação de conflito
        const conflito = AppState.reservas.find(r => {
            if (id && r.id === id) return false; // Ignora a própria reserva ao editar
            const inicioExistente = new Date(r.dataEntrada);
            const fimExistente = new Date(r.dataSaida);
            const inicioNovo = new Date(dataEntrada);
            const fimNovo = new Date(dataSaida);
            return inicioNovo <= fimExistente && fimNovo >= inicioExistente;
        });

        if (conflito) {
            showAlert(`Conflito de datas com a reserva de ${conflito.nome}.`);
            showLoader(false);
            return;
        }

        const reserva = {
            nome: $('#nomeHospede').value,
            telefone: $('#telefoneHospede').value,
            dataEntrada: dataEntrada,
            dataSaida: dataSaida,
            hospedes: $('#quantidadeHospedes').value,
            valor: parseFloat($('#valorReserva').value),
            notas: $('#notasReserva').value,
            pago: id ? (AppState.reservas.find(r => r.id === id)?.pago || false) : false,
            //createdAt: serverTimestamp() // pode ser útil
        };

        const docId = id || doc(collection(db, 'reservas')).id;
        
        try {
            await setDoc(doc(db, "reservas", docId), reserva);
            showAlert('Reserva salva com sucesso!');
            $('#reservaModal').classList.remove('visible');
        } catch (error) {
            console.error("Erro ao salvar reserva:", error);
            showAlert('Ocorreu um erro ao salvar a reserva.');
        } finally {
            showLoader(false);
        }
    }
    
    // --------------------------------------------------------------------
    // LÓGICA FINANCEIRA
    // --------------------------------------------------------------------
    function renderizarFinanceiro() {
        // Implementar lógica de renderização financeira aqui
    }

    // --------------------------------------------------------------------
    // LÓGICA GERAL DA UI (TABS, MODAIS, ETC)
    // --------------------------------------------------------------------
    function openTab(tabName) {
        $$('.tab-content').forEach(tab => tab.classList.remove('active'));
        $$('.nav-item').forEach(item => item.classList.remove('active'));

        $(`#${tabName}`).classList.add('active');
        $(`.nav-item[data-tab="${tabName}"]`).classList.add('active');
        
        AppState.ui.activeTab = tabName;
        $('#add-button').style.display = ['reservas', 'financeiro'].includes(tabName) ? 'flex' : 'none';
    }


</script>
</body>
</html>

